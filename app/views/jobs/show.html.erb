<% if @job.type == 0 %>
  <div class="breadcrumb-bar">
    <ul class="breadcrumbs">
      <li><%= link_to 'Kategorien端bersicht', :action => "index" %></li>
    </ul>
  </div>
  <div class="content white simple" id="categorie-view">
    <div id="categorie-details" class="row full-width space">
      <h1 class="title categorie">Kategorie: <%= @job.title %>
      <% if @user_role == 3 && user_signed_in?%>
        (<%= link_to 'Edit', edit_job_path(@job) %>)
      <% end %></h1>
      <div class="medium-3 columns">Bild</div>
      <div class="medium-5 columns">
        <div id="job-description" class="html-content">
          <%if @job.description.empty?%>
            Noch keine Beschreibung vorhanden...
          <%else%>
            <div class="job-description-preview"><%= truncate_html @job.description, :length => 50 %></div>
            <div class="job-description-full" style="display:none;"><%=@job.description.html_safe%></div>
          <%end%>
        </div>
      </div>
      <div class="medium-4 columns"><h2>Meist verwendete Schlagworte</h2></div>
    </div>
    <div class="blue-title">
      <h2>Eingeordnete Jobs <% if user_signed_in? %>(<%= link_to 'Neuer Job', :action => "new" %>)<% end %></h2>
    </div>
      <div id="job-subjobs" class="space">
      <%if @jobs.empty? && @offers.empty? %>
        <%= t('jobs_no_jobs') %>
      <% else %>
        <ul id="list-jobs" class="small-block-grid-1 medium-block-grid-2 large-block-grid-2">
          <li>
            <h3>Aufgaben</h3>
            <%if @jobs.empty? %>
              <%= t('jobs_no_jobs') %>
            <% else %>
              <% @jobs.each do |job| %>
                <div><%= link_to job.title, job %></div>
              <% end %>
            <% end %>
          </li>
          <li>
            <h3>Angebote</h3>
            <%if @offers.empty? %>
              <%= t('jobs_no_jobs') %>
            <% else %>
              <% @offers.each do |offer| %>
                <div><%= link_to offer.title, offer %></div>
              <% end %>
            <% end %>
          </li>
        </ul>
      <% end %>
    </div>
  </div>
<% else %>
  <div class="breadcrumb-bar">
    <ul class="breadcrumbs">
      <% if !@job.parent_id.nil? && Job.find(@job.parent_id).type == 0 %>
        <li><%= link_to 'Kategorien端bersicht', :action => "index" %></li>
      <%else%>
        <li><%= link_to 'Job端bersicht', :action => "index" %></li>
      <%end%> 
      <% @parent_jobs.each.with_index do |job,index| %>
        <% break if (job.id == @job.id)%>
        <li><%= link_to job.title, job %></li>
      <%end%>
    </ul>
  </div>

  <div class="row content white simple full-width <% if @job.status == 3 || user_signed_in? && @job.parent_id.nil? %>closed<% end %>" id="job-view" data-id="<%=@job.id%>">
    <div id="job-specification-area" class="medium-8 columns">
      <div id="job-details" class="space">
        <h1 class="title job">Aufgabe: <%= @job.title %> 
          <% if @user_role == 3 && user_signed_in?%>
          (<%= link_to 'Edit', edit_job_path(@job) %>)
        <% end %></h1>
        <div class="row">
          <div id="job-meta-wrapper" class="medium-8 columns top-margin">
            <div id="job-meta" class="row">
              <% if (!@job.latitude.nil? && !@job.longitude.nil?) && !@job.deadline.nil?
                @lessColumns = "medium-4" else @lessColumns = "medium-6" end %>
              <div id="job-status-wrapper" class="<%= @lessColumns %> columns">
                <%= render :partial => "status", :job => @job, :manager => @user_role %>
              </div>
              <% if not @job.deadline.nil? %>
              <div id="job-deadline" class="<%= @lessColumns %> columns left">
                <span class="left"><!----></span>
                <span class="icon-label" title="<%= @job.deadline.to_formatted_s(:long) %>">
                  <%=  distance_of_time_in_words(Time.now, @job.deadline, true) %>
                  <% if @job.deadline < DateTime.now %>
                    ago (expired)
                  <% else %>
                    to go
                  <% end %>
                </span>
              </div>
              <% end %>
              <% if !@job.latitude.nil? && !@job.longitude.nil? %>
                <div id="job-location" class="<%= @lessColumns %> columns">
                  <span class="icon left"><!----></span>
                  <span class="icon-label">
                    <%= link_to_modal @job.address, { :action => :map_for_job }, :remote => true, :id => "show-map-button" , :"data-lat" => @job.latitude, :"data-long" => @job.longitude %>
                  </span>
                  <span class="clear"></span>
                </div>
              <% end %>
            </div>
            <div id="job-description" class="html-content top-margin">
              <%if @job.description.empty?%>
                Noch keine Beschreibung vorhanden...
              <%else%>
                <div class="job-description-preview"><%= truncate_html @job.description, :length => 50 %>
                  <% if @job.description.html_safe.length > 50 %>
                    <%= link_to_function 'Alles lesen', "$('.job-description-preview').hide();$('.job-description-full').show();$('#splitter-close').show();$(this).parent().hide();" %>
                  <% end %>
                </div>
                <div class="job-description-full" style="display:none;"><%=@job.description.html_safe%>
                  <%= link_to_function 'Weniger', "$('.job-description-full').hide();$('.job-description-preview').show();$('#splitter-open').show();$(this).parent().hide();" %>
                </div>
              <%end%>
            </div>
            <div class="job-tags top-margin">
              <% if not @job.skill_list.empty? %>
                <ul class="small-block-grid-4 medium-block-grid-6 large-block-grid-8 tag-list">
                  <% @job.tag_counts_on(:skills, :limit => 5, :order => "count desc").each do |tag| %>
                    <li><%= link_to tag.name, { :controller => :tags, :action => :show, :id => tag.id }, :class => "tag" %></li>
                  <% end %>
                </ul>
              <% end %>
            </div>
          </div>
          <div class="job-workers-wrapper" class="medium-4 columns">
            <h2 class="with-buttons">Arbeiter 
            <%if @user_role == 3 %>
              <span class="right">
                <%= link_to_modal 'Verwalten', { :action => :show_manager_list }, :remote => true, :id => "edit-manager-button", :class => "button small"%>
              </span>
            <% end %>
            </h2>
            <div class="preview-list workers">
              <ul>
                <% if @workers.empty? && @user_role != 2 && current_user %>
                  <span class="profile-avatar add circle-button">
                    <%= link_to :action => :support, :support => true, :manager => @is_manager.empty? do%>
                      <span class='plus'>+</span>
                    <%end%>
                  </span>
                <% end %>
                <% @workers.each.with_index do |worker, index| %>
                  <li>
                    <% title = worker.name
                    if(worker.isCreator == 1)
                      title << " (Manager)"
                    end %>
                    <span class="profile-avatar"><%= link_to image_tag(avatar_url(worker), alt: "?"), worker, :title => title, :rel => "tipsy" %></span>
                  </li>
                  <% if index == 2 && (@workers.size - index) > 1%>
                    <li id="more-members">
                      <span class="circle-button">
                        <%= link_to "#more-members-content", :title => "#{@workers.size - index - 1} weitere Arbeiter", :rel => "tipsy", :class => "open-popup-link" do%>
                          <span class='points'>...</span>
                        <%end%>
                      </span>
                    </li>
                    <div id="more-members-content" class="white-popup mfp-hide">
                      <h1>Alle Mitarbeiter f端r <%=@job.title%></h1>
                      <div class="workers-list">
                        <% @workers.each.with_index do |worker, index| %>
                          <div class="worker">
                            <div class="left"><span class="profile-avatar"><%= link_to image_tag(avatar_url(worker), alt: "?"), worker %></span></div>
                            <div class="right"><%= link_to worker.name, worker %></div>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                  <% break if index == 2%>
                <%end%>
                  <li id="likes" <% if @job.likes.size == 0 %> class="hidden" <% end %>>
                    <span class="plus">+</span><span class="icon"></span><span class="icon-label likes-number">
                      <a href="#" title="
                         <%= #ToDo -> dynamisch per JS laden
                         @job.votes.up.by_type(User).voters.map{|v| v.name}.join(", ")%>
                         " rel="tipsy"><%= @job.likes.size %></a>
                    </span>
                  </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="blue-title">
        <h2>Eingeordnete Jobs <% if user_signed_in? %>(<%= link_to 'Neuer Job', :action => "new" %>)<% end %></h2>
      </div>
      <div id="job-subjobs" class="space">
        <%if @jobs.empty? && @offers.empty? %>
          <%= t('jobs_no_jobs') %>
        <% else %>
          <ul id="list-jobs" class="small-block-grid-1 medium-block-grid-2 large-block-grid-2">
            <li>
              <h3>Aufgaben</h3>
              <%if @jobs.empty? %>
                <%= t('jobs_no_jobs') %>
              <% else %>
                <% @jobs.each do |job| %>
                  <div><%= link_to job.title, job %></div>
                <% end %>
              <% end %>
            </li>
            <li>
              <h3>Angebote</h3>
              <%if @offers.empty? %>
                <%= t('jobs_no_jobs') %>
              <% else %>
                <% @offers.each do |offer| %>
                  <div><%= link_to offer.title, offer %></div>
                <% end %>
              <% end %>
            </li>
          </ul>
        <% end %>
      </div>
    </div>
    <div id="job-activities-area" class="medium-4 columns space">
      <h1 class="title">Aktivit&auml;ten</h1>
      <%if user_signed_in?%>
        <%= render :partial => "comments/form" %>
      <% else %>
        Du bist nicht angemeldet <%= link_to 'einloggen?', login_path, :class => "button"%>
      <% end %>
      <% @activities.each do |activity| %>
          <% if activity.key == "job.commented" %>
            <%= render_activity(activity, :layout => "layouts/activity_wrapper") %>
          <% else %>
            <%= render_activity(activity, :layout => "layouts/activity_wrapper") %>
          <% end %>
      <% end %>
    </div>
  </div>
  <%= gflash %>
<% end %>